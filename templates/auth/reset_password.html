{% extends "base.html" %}
{% block title %}Reset Password - TruthGuard{% endblock %}

{% block head_extra %}
<link rel="stylesheet" href="{{ url_for('static', filename='css/auth/auth.css') }}?v=1">
<link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.13.1/font/bootstrap-icons.min.css">
{% endblock %}

{% block content %}
<div class="auth-bg min-h-screen">
  <div class="auth-content">
    <!-- Hero Section -->
    <section class="relative isolate mx-auto max-w-7xl px-4 pt-12 md:px-6 md:pt-16">
      <div class="mx-auto max-w-md">
        <!-- Hero -->
        <div class="auth-hero fade-in">
          <span class="auth-badge">
            <span class="h-2 w-2 rounded-full bg-blue-500"></span>
            Password Reset
          </span>
          <h1 class="auth-title">Reset Your Password</h1>
          <p class="auth-subtitle">Create a new secure password for your TruthGuard account</p>
        </div>

        <!-- Password Reset Form Card -->
        <div class="auth-card p-8 fade-in">
          
          <div class="text-center mb-8">
            <div class="method-icon bg-blue-100 dark:bg-blue-900/30 text-blue-600 dark:text-blue-400 mx-auto mb-4">
              <i class="bi bi-key"></i>
            </div>
            <h2 class="text-xl font-semibold text-neutral-800 dark:text-neutral-200 mb-2">Create New Password</h2>
            <p class="text-neutral-600 dark:text-neutral-400">Set a strong password to secure your account</p>
          </div>

          <!-- Flash Messages -->
          {% with messages = get_flashed_messages(with_categories=true) %}
            {% if messages %}
              {% for category, message in messages %}
                <div class="alert alert-{{ 'error' if category == 'error' else 'success' if category == 'success' else 'info' }}">
                  <div class="flex items-center">
                    <i class="bi bi-{{ 'exclamation-triangle' if category == 'error' else 'check-circle' if category == 'success' else 'info-circle' }} mr-2"></i>
                    <span>{{ message }}</span>
                  </div>
                </div>
              {% endfor %}
            {% endif %}
          {% endwith %}

          <!-- Password Reset Form -->
          <form method="POST" action="{{ url_for('passwordreset.reset_password') }}" class="space-y-6" id="resetPasswordForm">
            <input type="hidden" name="token" value="{{ token }}">
            
            <!-- Email/Username Field for Browser Recognition -->
            {% if user_data %}
            <div class="form-group">
              <label for="email" class="form-label">
                <i class="bi bi-envelope form-icon"></i>
                Email Address
              </label>
              <div class="relative">
                <input 
                  type="email" 
                  id="email"
                  name="email"
                  class="auth-input ring-1 ring-inset ring-neutral-400/40 dark:ring-white/15 focus:ring-2 focus:ring-indigo-600 dark:focus:ring-2 dark:focus:ring-indigo-600"
                  value="{{ user_data.email }}"
                  readonly
                  autocomplete="email"
                />
                <div class="absolute inset-y-0 right-0 flex items-center pr-3">
                  <i class="bi bi-lock text-neutral-400"></i>
                </div>
              </div>
              <p class="text-xs mt-1 text-neutral-500 dark:text-neutral-400">This field is read-only for security</p>
            </div>
            {% endif %}
            
            <div class="form-group">
              <label for="new_password" class="form-label">
                <i class="bi bi-lock form-icon"></i>
                New Password
              </label>
              <div class="relative">
                <input 
                  type="password" 
                  id="new_password"
                  name="new_password"
                  class="auth-input ring-1 ring-inset ring-neutral-400/40 dark:ring-white/15 focus:ring-2 focus:ring-indigo-600 dark:focus:ring-2 dark:focus:ring-indigo-600"
                  placeholder="Create a strong password"
                  required
                  autocomplete="new-password"
                  minlength="6"
                  data-masked="true"
                />
                <button 
                  type="button" 
                  class="password-toggle"
                  onclick="togglePasswordMask('new_password')"
                  aria-label="Toggle password visibility"
                >
                  <i class="bi bi-eye"></i>
                </button>
              </div>
              
              <!-- Strength -->
              <div class="strength-bar">
                <div id="strengthFill" class="strength-fill" style="width:0%"></div>
              </div>
              <div class="flex justify-between items-center mt-1">
                <span class="text-sm text-neutral-600 dark:text-neutral-400">Password strength:</span>
                <span id="strengthText" class="text-sm font-medium">Weak</span>
              </div>

              <!-- Requirements -->
              <div class="requirements-list">
                <div class="text-sm font-medium text-neutral-700 dark:text-neutral-300 mb-2">Requirements:</div>
                <div class="space-y-1">
                  <div class="requirement-item" id="reqLength"><i class="bi bi-x-circle"></i><span>At least 6 characters</span></div>
                  <div class="requirement-item" id="reqUpper"><i class="bi bi-x-circle"></i><span>One uppercase letter</span></div>
                  <div class="requirement-item" id="reqLower"><i class="bi bi-x-circle"></i><span>One lowercase letter</span></div>
                  <div class="requirement-item" id="reqNumber"><i class="bi bi-x-circle"></i><span>One number</span></div>
                  <div class="requirement-item" id="reqSpecial"><i class="bi bi-x-circle"></i><span>One special character (!@#$%^&*)</span></div>
                </div>
              </div>
            </div>

            <!-- Confirm Password -->
            <div class="form-group">
              <label for="confirm_password" class="form-label">
                <i class="bi bi-shield-check form-icon"></i>
                Confirm New Password
              </label>
              <div class="relative">
                <input 
                  type="password" 
                  id="confirm_password"
                  name="confirm_password"
                  class="auth-input ring-1 ring-inset ring-neutral-400/40 dark:ring-white/15 focus:ring-2 focus:ring-indigo-600 dark:focus:ring-2 dark:focus:ring-indigo-600"
                  placeholder="Confirm your password"
                  required
                  autocomplete="new-password"
                  minlength="6"
                  data-masked="true"
                />
                <button 
                  type="button" 
                  class="password-toggle"
                  onclick="togglePasswordMask('confirm_password')"
                  aria-label="Toggle password visibility"
                >
                  <i class="bi bi-eye"></i>
                </button>
              </div>
              <div id="passwordMatch" class="password-match match hidden">
                <i class="bi bi-check-circle"></i>
                <span>Passwords match</span>
              </div>
              <div id="passwordNoMatch" class="password-match no-match hidden">
                <i class="bi bi-x-circle"></i>
                <span>Passwords do not match</span>
              </div>
            </div>

            <!-- Hidden username field for browser password manager recognition -->
            {% if user_data %}
            <input type="hidden" name="username" value="{{ user_data.email }}" autocomplete="username">
            <!-- Hidden password field for browser recognition (will be updated when form submits) -->
            <input type="hidden" id="final_password" name="password" value="" autocomplete="current-password">
            {% endif %}

            <button type="submit" class="auth-btn-primary" id="resetBtn">
              <i class="bi bi-check-circle mr-2"></i>
              Update Password
            </button>
          </form>

          <!-- Back to Login Link -->
          <div class="text-center mt-6">
            <a href="{{ url_for('auth.login') }}" class="auth-link text-sm">
              <i class="bi bi-arrow-left mr-1"></i>
              Back to Login
            </a>
          </div>
        </div>

        <!-- Security Features Section -->
        <div class="security-badges fade-in">
          <div class="badge">
            <i class="bi bi-shield-check"></i>
            <div>
              <div class="text-sm text-neutral-800 dark:text-neutral-200">Secure Reset Process</div>
              <div class="text-xs text-neutral-600 dark:text-neutral-400">Token-based authentication ensures your security</div>
            </div>
          </div>
          <div class="badge">
            <i class="bi bi-lock"></i>
            <div>
              <div class="text-sm text-neutral-800 dark:text-neutral-200">Password Encryption</div>
              <div class="text-xs text-neutral-600 dark:text-neutral-400">Your password is encrypted and securely stored</div>
            </div>
          </div>
          <div class="badge">
            <i class="bi bi-clock-history"></i>
            <div>
              <div class="text-sm text-neutral-800 dark:text-neutral-200">Temporary Access</div>
              <div class="text-xs text-neutral-600 dark:text-neutral-400">Reset link expires for your protection</div>
            </div>
          </div>
        </div>
      </div>
    </section>
  </div>
</div>
{% endblock %}

{% block body_extra %}
<script>
// Password toggle functionality matching register.html
function togglePasswordMask(inputId) {
  const input = document.getElementById(inputId);
  const icon = input.nextElementSibling.querySelector('i');
  const showing = input.type === 'password';
  input.type = showing ? 'text' : 'password';
  icon.classList.toggle('bi-eye', !showing);
  icon.classList.toggle('bi-eye-slash', showing);
}

// Password strength validation matching register form
document.addEventListener('DOMContentLoaded', function() {
  const form = document.getElementById('resetPasswordForm');
  const newPasswordInput = document.getElementById('new_password');
  const confirmPasswordInput = document.getElementById('confirm_password');
  const submitBtn = document.getElementById('resetBtn');
  const strengthFill = document.getElementById('strengthFill');
  const strengthText = document.getElementById('strengthText');
  const passwordMatch = document.getElementById('passwordMatch');
  const passwordNoMatch = document.getElementById('passwordNoMatch');

  // Password strength requirements
  const requirements = {
    length: document.getElementById('reqLength'),
    upper: document.getElementById('reqUpper'),
    lower: document.getElementById('reqLower'),
    number: document.getElementById('reqNumber'),
    special: document.getElementById('reqSpecial')
  };

  function updateRequirement(element, met) {
    const icon = element.querySelector('i');
    if (met) {
      element.classList.add('met');
      icon.className = 'bi bi-check-circle';
    } else {
      element.classList.remove('met');
      icon.className = 'bi bi-x-circle';
    }
  }

  function calculatePasswordStrength(password) {
    let strength = 0;
    const checks = {
      length: password.length >= 6,
      upper: /[A-Z]/.test(password),
      lower: /[a-z]/.test(password),
      number: /[0-9]/.test(password),
      special: /[^A-Za-z0-9]/.test(password)
    };

    // Update visual requirements
    Object.keys(checks).forEach(key => {
      updateRequirement(requirements[key], checks[key]);
      if (checks[key]) strength++;
    });

    return { strength, checks };
  }

  newPasswordInput.addEventListener('input', function(e) {
    const password = e.target.value;
    const { strength } = calculatePasswordStrength(password);
    
    // Update strength bar
    const strengthPercentage = (strength / 5) * 100;
    strengthFill.style.width = strengthPercentage + '%';
    
    // Update strength class and text
    strengthFill.className = 'strength-fill';
    strengthText.className = 'text-sm font-medium'; // Reset classes
    
    if (strength === 0) {
      strengthText.textContent = 'Weak';
      strengthFill.classList.add('strength-weak');
      strengthText.classList.add('strength-text-weak');
    } else if (strength === 1) {
      strengthText.textContent = 'Weak';
      strengthFill.classList.add('strength-weak');
      strengthText.classList.add('strength-text-weak');
    } else if (strength === 2) {
      strengthText.textContent = 'Fair';
      strengthFill.classList.add('strength-medium');
      strengthText.classList.add('strength-text-medium');
    } else if (strength === 3) {
      strengthText.textContent = 'Good';
      strengthFill.classList.add('strength-strong');
      strengthText.classList.add('strength-text-strong');
    } else if (strength === 4) {
      strengthText.textContent = 'Strong';
      strengthFill.classList.add('strength-strong');
      strengthText.classList.add('strength-text-strong');
    } else if (strength === 5) {
      strengthText.textContent = 'Very Strong';
      strengthFill.classList.add('strength-very-strong');
      strengthText.classList.add('strength-text-very-strong');
    }

    // Check password match if confirm field has value
    if (confirmPasswordInput.value) {
      checkPasswordMatch();
    }
  });

  function checkPasswordMatch() {
    const newPassword = newPasswordInput.value;
    const confirmPassword = confirmPasswordInput.value;
    
    if (!confirmPassword) {
      passwordMatch.classList.add('hidden');
      passwordNoMatch.classList.add('hidden');
      confirmPasswordInput.classList.remove('input-error', 'input-success');
      return;
    }

    if (newPassword === confirmPassword) {
      passwordMatch.classList.remove('hidden');
      passwordNoMatch.classList.add('hidden');
      confirmPasswordInput.classList.remove('input-error');
      confirmPasswordInput.classList.add('input-success');
    } else {
      passwordMatch.classList.add('hidden');
      passwordNoMatch.classList.remove('hidden');
      confirmPasswordInput.classList.remove('input-success');
      confirmPasswordInput.classList.add('input-error');
    }
  }

  confirmPasswordInput.addEventListener('input', checkPasswordMatch);

  // Form submission validation
  form.addEventListener('submit', function(e) {
    const newPassword = newPasswordInput.value;
    const confirmPassword = confirmPasswordInput.value;
    const { strength } = calculatePasswordStrength(newPassword);
    
    let isValid = true;
    
    // Check password strength (require at least 3/5 criteria met)
    if (strength < 3) {
      newPasswordInput.classList.add('input-error');
      isValid = false;
    } else {
      newPasswordInput.classList.remove('input-error');
    }
    
    // Check password match
    if (newPassword !== confirmPassword) {
      confirmPasswordInput.classList.add('input-error');
      isValid = false;
    } else {
      confirmPasswordInput.classList.remove('input-error');
    }
    
    if (!isValid) {
      e.preventDefault();
      return;
    }
    
    // Update hidden password field for browser recognition
    const finalPasswordField = document.getElementById('final_password');
    if (finalPasswordField) {
      finalPasswordField.value = newPassword;
    }
    
    // Show loading state
    submitBtn.innerHTML = '<span class="loading-spinner"></span>Updating Password...';
    submitBtn.disabled = true;
  });

  // Clear errors on input for all form inputs
  const allFormInputs = document.querySelectorAll('input');
  allFormInputs.forEach(input => {
    input.addEventListener('input', function() {
      this.classList.remove('input-error');
      // Also hide any visible error alerts when user starts typing
      const errorAlerts = document.querySelectorAll('.alert-error:not([style*="display: none"])');
      errorAlerts.forEach(alert => {
        if (alert.style.display !== 'none') {
          alert.style.opacity = '0';
          alert.style.transform = 'translateY(-10px)';
          setTimeout(() => {
            alert.style.display = 'none';
          }, 300);
        }
      });
    });
  });
  
  // Auto-hide error flash messages after 5 seconds (consistent with login.html)
  const errorAlerts = document.querySelectorAll('.alert-error');
  
  // If there are error alerts on page load, add error highlighting to form inputs initially
  if (errorAlerts.length > 0) {
    const formInputs = document.querySelectorAll('input[required]');
    formInputs.forEach(input => {
      input.classList.add('input-error');
    });
  }
  
  errorAlerts.forEach(alert => {
    setTimeout(() => {
      // Clear any field highlighting immediately when auto-hide starts
      const allInputs = document.querySelectorAll('input');
      allInputs.forEach(input => {
        input.classList.remove('input-error');
      });
      
      alert.style.transition = 'opacity 0.5s ease-out, transform 0.5s ease-out';
      alert.style.opacity = '0';
      alert.style.transform = 'translateY(-10px)';
      
      setTimeout(() => {
        alert.style.display = 'none';
      }, 500); // Wait for fade transition to complete
    }, 5000); // Hide after 5 seconds (consistent with login.html)
  });

  // Auto-hide success flash messages after 8 seconds (consistent with login.html)
  const successAlerts = document.querySelectorAll('.alert-success');
  successAlerts.forEach(alert => {
    setTimeout(() => {
      alert.style.transition = 'opacity 0.5s ease-out, transform 0.5s ease-out';
      alert.style.opacity = '0';
      alert.style.transform = 'translateY(-10px)';
      setTimeout(() => {
        alert.style.display = 'none';
      }, 500); // Wait for fade transition to complete
    }, 8000); // Hide after 8 seconds (consistent with login.html)
  });

  // Auto-hide info flash messages after 8 seconds (same as success messages)
  const infoAlerts = document.querySelectorAll('.alert-info');
  infoAlerts.forEach(alert => {
    setTimeout(() => {
      alert.style.transition = 'opacity 0.5s ease-out, transform 0.5s ease-out';
      alert.style.opacity = '0';
      alert.style.transform = 'translateY(-10px)';
      setTimeout(() => {
        alert.style.display = 'none';
      }, 500); // Wait for fade transition to complete
    }, 8000); // Hide after 8 seconds (same as success for consistency)
  });
});
</script>
{% endblock %}
