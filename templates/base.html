<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>{% block title %}TruthGuard â€¢ AI Fake News Detector{% endblock %}</title>
  <link rel="    details[id="moreDropdown"] summary.more-parent-active::after {
      content: "";
      position: absolute;
      left: 0; right: 0;
      height: 2px;
      bottom: -6px; /* Move active state underline down more */
      background: #4f46e5;
      border-radius: 9999px;
      opacity: 1;
    }" href="https://fonts.googleapis.com">
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700;800&display=swap" rel="stylesheet">
  
  <!-- Base styles for consistent navigation and theming -->
  <link rel="stylesheet" href="{{ url_for('static', filename='css/base.css') }}">

  <!-- Theme bootstrap (default dark) -->
  <script>
    (() => {
      const KEY = 'theme-preference';
      const root = document.documentElement;
      const mql = window.matchMedia?.('(prefers-color-scheme: dark)');
      const prefersDark = () => (mql ? mql.matches : true);

      function applyTheme(theme) {
        const isDark = theme === 'dark' || (theme === 'system' && prefersDark());
        root.classList.toggle('dark', isDark);
        root.dataset.theme = theme;
      }
      function setTheme(theme) {
        localStorage.setItem(KEY, theme);
        applyTheme(theme);
        const label = document.getElementById('themeLabel');
        if (label) label.textContent = theme[0].toUpperCase() + theme.slice(1);
        document.querySelectorAll('[data-theme-option]').forEach(btn => {
          const active = btn.dataset.themeOption === theme;
          if (active) {
            btn.classList.remove(
              'bg-neutral-900','bg-white/10',
              'bg-white','dark:bg-neutral-900/70','dark:bg-neutral-900/50'
            );
          }
          btn.classList.toggle('bg-indigo-600', active && !document.documentElement.classList.contains('dark'));
          btn.classList.toggle('text-white', active && !document.documentElement.classList.contains('dark'));
          btn.classList.toggle('bg-indigo-500/25', active && document.documentElement.classList.contains('dark'));
          btn.classList.toggle('text-indigo-200', active && document.documentElement.classList.contains('dark'));
          btn.classList.toggle('theme-active', active);
        });
      }

      applyTheme(localStorage.getItem(KEY) || 'dark');
      mql?.addEventListener?.('change', () => {
        if ((localStorage.getItem(KEY) || 'dark') === 'system') applyTheme('system');
      });
      window.__setTheme = setTheme;
    })();
  </script>

  <!-- Tailwind -->
  <script src="https://cdn.tailwindcss.com"></script>
  <script>
    tailwind.config = {
      darkMode: 'class',
      theme: {
        extend: {
          fontFamily: { sans: ['Inter','ui-sans-serif','system-ui','sans-serif'] }
        }
      }
    }
  </script>

  <style>
    :root{ --nav-h: 64px; }
    html,body{ height:100%; }
    @supports not (overflow-x: clip){ html,body{ overflow-x:hidden; } }
    body.menu-open #navBar { border-bottom-color: transparent; }

    /* Active nav styles */
    .nav-link { 
      border-radius: .5rem; 
      padding: .25rem .5rem; 
      font-size: .875rem; 
      transition: background-color .2s,color .2s;
      position: relative;
      display: inline-flex; /* Match More dropdown */
      align-items: center; /* Ensure vertical centering */
      line-height: 1.25rem; /* Consistent line height */
    }
    .nav-link:hover { 
      background-color: rgba(0,0,0,.05); 
      position: relative;
    }
    .nav-link:hover::after {
      content: "";
      position: absolute;
      left: 0; right: 0;
      height: 2px;
      bottom: -6px;
      background: #4f46e5;
      border-radius: 9999px;
      opacity: 0.6;
    }
    html.dark .nav-link:hover { background-color: rgba(255,255,255,.05); }
    html.dark .nav-link:hover::after { background:#6366f1; }

    .nav-link-mobile { 
      display:block; 
      border-radius: .75rem; 
      padding:.5rem 1rem; 
      font-size:1rem; 
      transition: background-color .2s,color .2s;
      position: relative;
    }
    .nav-link-mobile:hover { background-color: rgba(0,0,0,.05); }
    html.dark .nav-link-mobile:hover { background-color: rgba(255,255,255,.05); }

    /* Bottom-tab style active indicator */
    .nav-link.active {
      background: transparent !important;
      color: #4f46e5 !important;
      font-weight: 600;
    }
    .nav-link.active::after {
      content: "";
      position: absolute;
      left: 0; right: 0;
      height: 2px;
      bottom: -6px;
      background: #4f46e5;
      border-radius: 9999px;
      opacity: 1;
    }
    html.dark .nav-link.active { color:#a5b4fc !important; }
    html.dark .nav-link.active::after { background:#6366f1; }

    /* Mobile menu: left accent bar */
    .nav-link-mobile.active {
      background: transparent !important;
      color:#4f46e5 !important;
      font-weight: 600;
    }
    .nav-link-mobile.active::before {
      content:"";
      position:absolute;
      left:8px; top:6px; bottom:6px;
      width:3px;
      background:#4f46e5;
      border-radius:9999px;
    }
    html.dark .nav-link-mobile.active { color:#a5b4fc !important; }
    html.dark .nav-link-mobile.active::before { background:#6366f1; }

    /* Theme option styles */
    [data-theme-option].theme-active{
      background-color:#4f46e5 !important;
      color:#fff !important;
      border-color: rgb(129 140 248 / .4) !important;
    }
    html.dark [data-theme-option].theme-active{
      background-color:rgba(99,102,241,.25) !important;
      color:#c7d2fe !important;
      border-color: rgb(165 180 252 / .35) !important;
    }

    /* User dropdown option styles - matching theme dropdown */
    [data-user-option].user-active{
      background-color:#4f46e5 !important;
      color:#fff !important;
    }
    html.dark [data-user-option].user-active{
      background-color:rgba(99,102,241,.25) !important;
      color:#c7d2fe !important;
    }

    /* More dropdown option styles - matching other dropdowns */
    [data-more-option].more-active{
      background-color:#4f46e5 !important;
      color:#fff !important;
    }
    html.dark [data-more-option].more-active{
      background-color:rgba(99,102,241,.25) !important;
      color:#c7d2fe !important;
    }

    /* Mobile More dropdown option styles */
    [data-more-option-mobile].more-active{
      background-color:#4f46e5 !important;
      color:#fff !important;
    }
    html.dark [data-more-option-mobile].more-active{
      background-color:rgba(99,102,241,.25) !important;
      color:#c7d2fe !important;
    }

    /* Mobile More summary active state */
    #moreSummaryMobile {
      position: relative;
    }
    #moreSummaryMobile.more-parent-active {
      background: transparent !important;
      color: #4f46e5 !important;
      font-weight: 600;
    }
    #moreSummaryMobile.more-parent-active::before {
      content: "";
      position: absolute;
      left: 8px; 
      top: 6px; 
      bottom: 6px;
      width: 3px;
      background: #4f46e5;
      border-radius: 9999px;
    }
    html.dark #moreSummaryMobile.more-parent-active { 
      color: #a5b4fc !important; 
    }
    html.dark #moreSummaryMobile.more-parent-active::before { 
      background: #6366f1; 
    }

    /* More dropdown styling to match nav-link behavior */
    details[id="moreDropdown"] summary {
      position: relative;
      /* Other properties now inherited from .nav-link class */
    }
    details[id="moreDropdown"] summary:hover::after,
    details[id="moreDropdown"][open] summary::after {
      content: "";
      position: absolute;
      left: 0; right: 0;
      height: 2px;
      bottom: -6px; /* Move hover state underline down more */
      background: #4f46e5;
      border-radius: 9999px;
      opacity: 0.6;
    }
    details[id="moreDropdown"] summary:hover,
    details[id="moreDropdown"][open] summary {
      color: #6366f1 !important; /* Indigo-500 - same as nav-link hover */
    }
    html.dark details[id="moreDropdown"] summary:hover::after,
    html.dark details[id="moreDropdown"][open] summary::after { 
      background: #6366f1; 
    }
    html.dark details[id="moreDropdown"] summary:hover,
    html.dark details[id="moreDropdown"][open] summary {
      color: #818cf8 !important; /* Indigo-400 for dark mode */
    }

    /* More dropdown active state when any dropdown item is active */
    details[id="moreDropdown"] summary.more-parent-active {
      background: transparent !important;
      color: #4f46e5 !important;
      font-weight: 600;
    }
    details[id="moreDropdown"] summary.more-parent-active::after {
      content: "";
      position: absolute;
      left: 0; right: 0;
      height: 2px;
      bottom: -5.75px; /* Revert active state to original position */
      background: #4f46e5;
      border-radius: 9999px;
      opacity: 1;
    }
    html.dark details[id="moreDropdown"] summary.more-parent-active { 
      color: #a5b4fc !important; 
    }
    html.dark details[id="moreDropdown"] summary.more-parent-active::after { 
      background: #6366f1; 
    }

    /* Logout button styling */
    #logoutBtn {
      color: #dc2626 !important; /* red-600 for light mode */
    }
    #logoutBtn:hover {
      background-color: #fef2f2 !important; /* red-50 for light mode */
    }
    html.dark #logoutBtn {
      color: #fca5a5 !important; /* red-300 for better contrast in dark mode */
    }
    html.dark #logoutBtn:hover {
      background-color: #991b1b !important; /* red-800 for dark mode */
    }

    #mobileMenu a, #mobileMenu button { -webkit-tap-highlight-color: transparent; }
  </style>

  {% block head_extra %}{% endblock %}
</head>

<body class="min-h-screen pt-[var(--nav-h)] bg-white text-neutral-900 antialiased dark:bg-neutral-950 dark:text-neutral-100 overflow-x-clip">
  <!-- HEADER: glass background wraps navbar + mobile menu -->
  <header id="siteHeader" class="fixed inset-x-0 top-0 z-[80]">
    <div id="glassWrap"
         class="bg-white/70 backdrop-blur supports-[backdrop-filter]:bg-white/60
                dark:bg-neutral-950/60 dark:supports-[backdrop-filter]:bg-neutral-950/50">

      <!-- NAVBAR -->
      <div id="navBar" class="border-b-2 border-neutral-300/80 dark:border-white/15">
        <nav class="mx-auto grid max-w-7xl grid-cols-[auto,1fr,auto] items-center gap-4 px-4 py-4 md:px-6">
          <!-- Brand -->
          <a href="{{ url_for('main.index') }}" class="flex items-center gap-2 shrink-0 select-none" aria-label="TruthGuard home">
            <span class="grid h-9 w-9 place-items-center rounded-xl bg-gradient-to-br from-indigo-500 to-violet-600 text-white shadow-md">
              <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="currentColor" class="h-5 w-5">
                <path d="M12 2 4 5v6c0 5 3.4 8.6 8 11 4.6-2.4 8-6 8-11V5l-8-3Z"/>
              </svg>
            </span>
            <span class="text-lg font-semibold tracking-tight">TruthGuard</span>
          </a>

          <!-- Center links (desktop) -->
          <ul class="hidden items-center justify-self-center gap-8 xl:flex" id="desktopNav">
            {% if session.get('user_id') %}
            <li><a class="nav-link rounded-md px-2 py-1 text-sm text-neutral-800 dark:text-neutral-300" href="{{ url_for('main.index') }}" data-nav="home">Home</a></li>
            <li><a class="nav-link rounded-md px-2 py-1 text-sm text-neutral-800 dark:text-neutral-300" href="{{ url_for('main.detector_page') }}" data-nav="detector">Detector</a></li>
            <li><a class="nav-link rounded-md px-2 py-1 text-sm text-neutral-800 dark:text-neutral-300" href="{{ url_for('main.history_page') }}" data-nav="history">History</a></li>
            <li><a class="nav-link rounded-md px-2 py-1 text-sm text-neutral-800 dark:text-neutral-300" href="{{ url_for('game.game_hub') }}" data-nav="game">Game</a></li>
            <li>
              <!-- More dropdown -->
              <details id="moreDropdown" class="group relative">
                <summary id="moreSummary" class="nav-link flex cursor-pointer list-none items-center gap-1 rounded-md px-2 py-1 text-sm text-neutral-800 hover:bg-black/5 dark:text-neutral-300 dark:hover:bg-white/5">
                  <span>More</span>
                  <svg class="h-3 w-3" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="m6 9 6 6 6-6"/></svg>
                </summary>
                <div id="moreMenu" class="absolute left-0 mt-2 w-32 overflow-hidden rounded-xl border border-neutral-300/80 bg-white p-1 shadow-xl ring-1 ring-black/5 dark:border-white/15 dark:bg-neutral-900">
                  <a href="{{ url_for('main.about_page') }}" data-more-option="about" class="flex w-full items-center gap-2 rounded-lg px-3 py-2 text-sm text-neutral-700 hover:bg-black/5 dark:text-neutral-200 dark:hover:bg-white/5 mb-1">
                    <svg class="h-4 w-4" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><circle cx="12" cy="12" r="10"/><path d="M9.09 9a3 3 0 0 1 5.83 1c0 2-3 3-3 3"/><path d="M12 17h.01"/></svg>
                    About
                  </a>
                  <a href="{{ url_for('admin.admin_feedback') if user_is_admin else url_for('main.feedback_page') }}" data-more-option="feedback" class="flex w-full items-center gap-2 rounded-lg px-3 py-2 text-sm text-neutral-700 hover:bg-black/5 dark:text-neutral-200 dark:hover:bg-white/5">
                    <svg class="h-4 w-4" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M21 15a2 2 0 0 1-2 2H7l-4 4V5a2 2 0 0 1 2-2h14a2 2 0 0 1 2 2z"/></svg>
                    Feedback
                  </a>
                </div>
              </details>
            </li>
            {% endif %}
          </ul>

          <!-- Right controls (desktop) -->
          <div class="hidden items-center justify-self-end gap-3 xl:flex">
            <!-- Theme dropdown -->
            <details id="themeDropdown" class="group relative">
              <summary id="themeSummary" class="flex w-36 cursor-pointer list-none items-center justify-between rounded-xl border border-neutral-300/80 bg-transparent px-3 py-2 text-sm text-neutral-700 hover:bg-black/5 dark:border-white/15 dark:text-neutral-200 dark:hover:bg-white/5">
                <span id="themeLabel">Dark</span>
                <svg class="h-4 w-4" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="m6 9 6 6 6-6"/></svg>
              </summary>
              <div id="themeMenu" class="absolute right-0 mt-2 w-36 overflow-hidden rounded-xl border border-neutral-300/80 bg-white p-1 shadow-xl ring-1 ring-black/5 dark:border-white/15 dark:bg-neutral-900">
                <button data-theme-option="light" class="flex w-full items-center gap-2 rounded-lg px-3 py-2 text-sm text-neutral-700 hover:bg-black/5 dark:text-neutral-200 dark:hover:bg-white/5">
                  <svg class="h-4 w-4" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="currentColor"><path d="M12 2.25a.75.75 0 0 1 .75.75v2.25a.75.75 0 0 1-1.5 0V3a.75.75 0 0 1 .75-.75ZM7.5 12a4.5 4.5 0 1 1 9 0 4.5 4.5 0 0 1-9 0ZM18.894 6.166a.75.75 0 0 0-1.06-1.06l-1.591 1.59a.75.75 0 1 0 1.06 1.061l1.591-1.59ZM21.75 12a.75.75 0 0 1-.75.75h-2.25a.75.75 0 0 1 0-1.5H21a.75.75 0 0 1 .75.75ZM17.834 18.894a.75.75 0 0 0 1.06-1.06l-1.59-1.591a.75.75 0 1 0-1.061 1.06l1.59 1.591ZM12 18a.75.75 0 0 1 .75.75V21a.75.75 0 0 1-1.5 0v-2.25A.75.75 0 0 1 12 18ZM7.758 17.303a.75.75 0 0 0-1.061-1.06l-1.591 1.59a.75.75 0 0 0 1.06 1.061l1.591-1.59ZM6 12a.75.75 0 0 1-.75.75H3a.75.75 0 0 1 0-1.5h2.25A.75.75 0 0 1 6 12ZM6.697 7.757a.75.75 0 0 0 1.06-1.06l-1.59-1.591a.75.75 0 0 0-1.061 1.06l1.59 1.591Z"/></svg>
                  Light
                </button>
                <button data-theme-option="dark" class="flex w-full items-center gap-2 rounded-lg px-3 py-2 text-sm text-neutral-700 hover:bg-black/5 dark:text-neutral-200 dark:hover:bg-white/5">
                  <svg class="h-4 w-4" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="currentColor"><path d="M9.528 1.718a.75.75 0 0 1 .162.819A8.97 8.97 0 0 0 9 6a9 9 0 0 0 9 9 8.97 8.97 0 0 0 3.463-.69.75.75 0 0 1 .981.98 10.503 10.503 0 0 1-9.694 6.46c-5.799 0-10.5-4.7-10.5-10.5 0-4.368 2.667-8.112 6.46-9.694a.75.75 0 0 1 .818.162Z"/></svg>
                  Dark
                </button>
                <button data-theme-option="system" class="flex w-full items-center gap-2 rounded-lg px-3 py-2 text-sm text-neutral-700 hover:bg-black/5 dark:text-neutral-200 dark:hover:bg-white/5">
                  <svg class="h-4 w-4" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="currentColor"><path d="M3 4.5A1.5 1.5 0 0 1 4.5 3h15A1.5 1.5 0 0 1 21 4.5v11.25A1.5 1.5 0 0 1 19.5 17H4.5a1.5 1.5 0 0 1-1.5-1.5V4.5Zm12 7.5a.75.75 0 0 0 1.5 0V8.25a.75.75 0 0 0-1.5 0v3.75ZM8.25 12a.75.75 0 0 0 1.5 0V8.25a.75.75 0 0 0-1.5 0V12ZM12 12a.75.75 0 0 0 1.5 0V8.25a.75.75 0 0 0-1.5 0V12Z"/></svg>
                  System
                </button>
              </div>
            </details>

            <!-- Auth buttons (when not logged in) -->
            {% if not session.get('user_id') %}
            <a href="{{ url_for('auth.login') }}" class="inline-flex items-center gap-2 rounded-xl border border-neutral-300/80 bg-transparent px-4 py-2 text-sm font-medium text-neutral-900 hover:bg-black/5 dark:border-white/15 dark:text-white dark:hover:bg-white/5">Log in</a>
            <a href="{{ url_for('auth.register') }}" class="inline-flex items-center gap-2 rounded-xl bg-indigo-600 px-4 py-2 text-sm font-semibold text-white shadow-sm ring-1 ring-inset ring-indigo-500/30 hover:bg-indigo-700">Sign up</a>
            {% else %}
            <!-- User dropdown (when logged in) -->
            <details id="userDropdown" class="group relative">
              <summary id="userSummary" class="flex cursor-pointer list-none items-center gap-2 rounded-xl border border-neutral-300/80 bg-transparent px-3 py-2 text-sm text-neutral-700 hover:bg-black/5 dark:border-white/15 dark:text-neutral-200 dark:hover:bg-white/5">
                <div class="flex h-7 w-7 items-center justify-center rounded-full bg-indigo-600 text-xs font-semibold text-white">
                  {{ session.get('username', 'U')[0].upper() }}
                </div>
                <span class="font-medium">{{ session.get('username', 'User') }}</span>
                <svg class="h-4 w-4" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="m6 9 6 6 6-6"/></svg>
              </summary>
              <div id="userMenu" class="absolute right-0 mt-2 w-48 overflow-hidden rounded-xl border border-neutral-300/80 bg-white p-1 shadow-xl ring-1 ring-black/5 dark:border-white/15 dark:bg-neutral-900">
                <a href="{{ url_for('auth.profile') }}" data-user-option="profile" class="flex w-full items-center gap-2 rounded-lg px-3 py-2 text-sm text-neutral-700 hover:bg-black/5 dark:text-neutral-200 dark:hover:bg-white/5 mb-1">
                  <svg class="h-4 w-4" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M20 21v-2a4 4 0 0 0-4-4H8a4 4 0 0 0-4 4v2"/><circle cx="12" cy="7" r="4"/></svg>
                  Profile Management
                </a>
                <a href="{{ url_for('main.about_page') }}" data-user-option="help" class="flex w-full items-center gap-2 rounded-lg px-3 py-2 text-sm text-neutral-700 hover:bg-black/5 dark:text-neutral-200 dark:hover:bg-white/5 mb-1">
                  <svg class="h-4 w-4" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><circle cx="12" cy="12" r="10"/><path d="M9.09 9a3 3 0 0 1 5.83 1c0 2-3 3-3 3"/><path d="M12 17h.01"/></svg>
                  Help
                </a>
                <hr class="border-neutral-200 dark:border-neutral-700 my-1">
                <button type="button" id="logoutBtn" data-user-option="logout" class="flex w-full items-center gap-2 rounded-lg px-3 py-2 text-sm text-neutral-700 hover:bg-black/5 dark:text-neutral-200 dark:hover:bg-white/5">
                  <svg class="h-4 w-4" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M9 21H5a2 2 0 0 1-2-2V5a2 2 0 0 1 2-2h4"/><polyline points="16,17 21,12 16,7"/><line x1="21" y1="12" x2="9" y2="12"/></svg>
                  Logout
                </button>
                <form id="logoutForm" method="POST" action="{{ url_for('auth.logout') }}" style="display: none;">
                  <!-- Hidden form for logout submission -->
                </form>
              </div>
            </details>
            {% endif %}
          </div>

          <!-- Mobile trigger -->
          <button id="menuBtn" class="justify-self-end inline-flex h-10 w-10 items-center justify-center rounded-xl border border-neutral-300/80 text-neutral-700 hover:bg-black/5 xl:hidden dark:border-white/15 dark:text-neutral-200 dark:hover:bg-white/5" aria-label="Toggle Navigation" aria-expanded="false">
            <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-width="1.5" d="M4 7h16M4 12h16M4 17h16"/></svg>
          </button>
        </nav>
      </div>

      <!-- MOBILE MENU -->
      <div id="mobileMenu" class="hidden xl:hidden">
        <div class="mx-auto max-w-7xl px-4 pb-6">
          <div class="rounded-3xl border border-neutral-200 bg-white/80 px-4 py-5 shadow-[0_10px_30px_rgba(2,6,23,0.06)] ring-1 ring-black/5 backdrop-blur-xl
                      dark:border-white/10 dark:bg-neutral-950/60 dark:ring-0 dark:shadow-[inset_0_1px_0_rgba(255,255,255,.06)]">
            <nav class="space-y-2 pb-4" id="mobileNav">
              {% if session.get('user_id') %}
              <a href="{{ url_for('main.index') }}" class="nav-link-mobile block rounded-xl px-4 py-2 text-base font-medium text-neutral-900 transition dark:text-white/90" data-nav="home">Home</a>
              <a href="{{ url_for('main.detector_page') }}" class="nav-link-mobile block rounded-xl px-4 py-2 text-base font-medium text-neutral-900 transition dark:text-white/90" data-nav="detector">Detector</a>
              <a href="{{ url_for('main.history_page') }}" class="nav-link-mobile block rounded-xl px-4 py-2 text-base font-medium text-neutral-900 transition dark:text-white/90" data-nav="history">History</a>
              <a href="{{ url_for('game.game_hub') }}" class="nav-link-mobile block rounded-xl px-4 py-2 text-base font-medium text-neutral-900 transition dark:text-white/90" data-nav="game">Game</a>
              
              <!-- More section for mobile -->
              <details id="moreDropdownMobile" class="group">
                <summary id="moreSummaryMobile" class="nav-link-mobile flex cursor-pointer list-none items-center justify-between rounded-xl px-4 py-2 text-base font-medium text-neutral-900 transition dark:text-white/90">
                  <span>More</span>
                  <svg class="h-4 w-4 transition-transform group-open:rotate-180" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="m6 9 6 6 6-6"/></svg>
                </summary>
                <div class="mt-2 ml-4 space-y-1">
                  <a href="{{ url_for('main.about_page') }}" class="block rounded-xl px-4 py-2 text-sm font-medium text-neutral-700 transition hover:bg-black/5 dark:text-white/70 dark:hover:bg-white/5" data-more-option-mobile="about">
                    <div class="flex items-center gap-2">
                      <svg class="h-4 w-4" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><circle cx="12" cy="12" r="10"/><path d="M9.09 9a3 3 0 0 1 5.83 1c0 2-3 3-3 3"/><path d="M12 17h.01"/></svg>
                      About
                    </div>
                  </a>
                  <a href="{{ url_for('admin.admin_feedback') if user_is_admin else url_for('main.feedback_page') }}" class="block rounded-xl px-4 py-2 text-sm font-medium text-neutral-700 transition hover:bg-black/5 dark:text-white/70 dark:hover:bg-white/5" data-more-option-mobile="feedback">
                    <div class="flex items-center gap-2">
                      <svg class="h-4 w-4" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M21 15a2 2 0 0 1-2 2H7l-4 4V5a2 2 0 0 1 2-2h14a2 2 0 0 1 2 2z"/></svg>
                      Feedback
                    </div>
                  </a>
                </div>
              </details>
              {% endif %}
            </nav>

            <section class="rounded-3xl border border-neutral-200 p-4 dark:border-white/10">
              <p class="px-2 pb-3 text-xs font-semibold uppercase tracking-wider text-neutral-500 dark:text-neutral-400">Theme</p>
              <div class="space-y-1">
                <button data-theme-option="light" class="flex w-full items-center gap-3 rounded-xl border border-neutral-200 px-3 py-2 text-sm font-medium text-neutral-900 hover:bg-black/5 dark:border-white/10 dark:text-white dark:hover:bg-white/5">
                  <svg class="h-4 w-4" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="currentColor"><path d="M12 2.25a.75.75 0 0 1 .75.75v2.25a.75.75 0 0 1-1.5 0V3a.75.75 0 0 1 .75-.75ZM7.5 12a4.5 4.5 0 1 1 9 0 4.5 4.5 0 0 1-9 0ZM18.894 6.166a.75.75 0 0 0-1.06-1.06l-1.591 1.59a.75.75 0 1 0 1.06 1.061l1.591-1.59ZM21.75 12a.75.75 0 0 1-.75.75h-2.25a.75.75 0 0 1 0-1.5H21a.75.75 0 0 1 .75.75ZM17.834 18.894a.75.75 0 0 0 1.06-1.06l-1.59-1.591a.75.75 0 1 0-1.061 1.06l1.59 1.591ZM12 18a.75.75 0 0 1 .75.75V21a.75.75 0 0 1-1.5 0v-2.25A.75.75 0 0 1 12 18ZM7.758 17.303a.75.75 0 0 0-1.061-1.06l-1.591 1.59a.75.75 0 0 0 1.06 1.061l1.591-1.59ZM6 12a.75.75 0 0 1-.75.75H3a.75.75 0 0 1 0-1.5h2.25A.75.75 0 0 1 6 12ZM6.697 7.757a.75.75 0 0 0 1.06-1.06l-1.59-1.591a.75.75 0 0 0-1.061 1.06l1.59 1.591Z"/></svg>
                  Light
                </button>
                <button data-theme-option="dark" class="flex w-full items-center gap-3 rounded-xl border border-neutral-200 px-3 py-2 text-sm font-medium text-neutral-900 hover:bg-black/5 dark:border-white/10 dark:text-white dark:hover:bg-white/5">
                  <svg class="h-4 w-4" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="currentColor"><path d="M9.528 1.718a.75.75 0 0 1 .162.819A8.97 8.97 0 0 0 9 6a9 9 0 0 0 9 9 8.97 8.97 0 0 0 3.463-.69.75.75 0 0 1 .981.98 10.503 10.503 0 0 1-9.694 6.46c-5.799 0-10.5-4.7-10.5-10.5 0-4.368 2.667-8.112 6.46-9.694a.75.75 0 0 1 .818.162Z"/></svg>
                  Dark
                </button>
                <button data-theme-option="system" class="flex w-full items-center gap-3 rounded-xl border border-neutral-200 px-3 py-2 text-sm font-medium text-neutral-900 hover:bg-black/5 dark:border-white/10 dark:text-white dark:hover:bg-white/5">
                  <svg class="h-4 w-4" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="currentColor"><path d="M3 4.5A1.5 1.5 0 0 1 4.5 3h15A1.5 1.5 0 0 1 21 4.5v11.25A1.5 1.5 0 0 1 19.5 17H4.5a1.5 1.5 0 0 1-1.5-1.5V4.5Zm12 7.5a.75.75 0 0 0 1.5 0V8.25a.75.75 0 0 0-1.5 0v3.75ZM8.25 12a.75.75 0 0 0 1.5 0V8.25a.75.75 0 0 0-1.5 0V12ZM12 12a.75.75 0 0 0 1.5 0V8.25a.75.75 0 0 0-1.5 0V12Z"/></svg>
                  System
                </button>
              </div>
            </section>

            <div class="mt-4 grid gap-3">
              {% if not session.get('user_id') %}
              <a href="{{ url_for('auth.login') }}" class="inline-flex items-center justify-center gap-2 rounded-xl border border-neutral-300/80 bg-transparent px-4 py-2 text-sm font-medium text-neutral-900 hover:bg-black/5 dark:border-white/15 dark:text-white dark:hover:bg-white/5">Log in</a>
              <a href="{{ url_for('auth.register') }}" class="inline-flex items-center justify-center gap-2 rounded-xl bg-indigo-600 px-4 py-2 text-sm font-semibold text-white shadow-sm ring-1 ring-inset ring-indigo-500/30 hover:bg-indigo-700">Sign up</a>
              {% else %}
              <!-- User info section -->
              <div class="rounded-xl border border-neutral-200 p-4 dark:border-white/10">
                <div class="flex items-center gap-3 mb-3">
                  <div class="flex h-10 w-10 items-center justify-center rounded-full bg-indigo-600 text-sm font-semibold text-white">
                    {{ session.get('username', 'U')[0].upper() }}
                  </div>
                  <div>
                    <p class="font-medium text-neutral-900 dark:text-white">{{ session.get('username', 'User') }}</p>
                    <p class="text-xs text-neutral-500 dark:text-neutral-400">Logged in</p>
                  </div>
                </div>
                <div class="space-y-1">
                  <a href="{{ url_for('auth.profile') }}" class="flex w-full items-center gap-3 rounded-xl border border-neutral-200 px-3 py-2 text-sm font-medium text-neutral-900 hover:bg-black/5 dark:border-white/10 dark:text-white dark:hover:bg-white/5">
                    <svg class="h-4 w-4" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M20 21v-2a4 4 0 0 0-4-4H8a4 4 0 0 0-4 4v2"/><circle cx="12" cy="7" r="4"/></svg>
                    Profile Management
                  </a>
                  <a href="{{ url_for('main.about_page') }}" class="flex w-full items-center gap-3 rounded-xl border border-neutral-200 px-3 py-2 text-sm font-medium text-neutral-900 hover:bg-black/5 dark:border-white/10 dark:text-white dark:hover:bg-white/5">
                    <svg class="h-4 w-4" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><circle cx="12" cy="12" r="10"/><path d="M9.09 9a3 3 0 0 1 5.83 1c0 2-3 3-3 3"/><path d="M12 17h.01"/></svg>
                    Help
                  </a>
                  <form method="POST" action="{{ url_for('auth.logout') }}" class="w-full">
                    <button type="submit" class="flex w-full items-center gap-3 rounded-xl border border-red-200 px-3 py-2 text-sm font-medium text-red-600 hover:bg-red-50 dark:border-red-800/30 dark:text-red-400 dark:hover:bg-red-900/20">
                      <svg class="h-4 w-4" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M9 21H5a2 2 0 0 1-2-2V5a2 2 0 0 1 2-2h4"/><polyline points="16,17 21,12 16,7"/><line x1="21" y1="12" x2="9" y2="12"/></svg>
                      Logout
                    </button>
                  </form>
                </div>
              </div>
              {% endif %}
            </div>
          </div>
        </div>
      </div>
    </div>
  </header>

  <!-- Backdrop -->
  <div id="menuBackdrop" class="fixed inset-x-0 top-[var(--nav-h)] hidden z-[60] bg-black/30"></div>

  {% block content %}{% endblock %}

  <footer class="mt-24 border-t-2 border-neutral-300/80 bg-white dark:border-white/15 dark:bg-neutral-950">
    <div class="mx-auto flex max-w-7xl flex-col items-center justify-between gap-4 px-4 py-8 text-sm text-neutral-700 md:flex-row md:px-6 dark:text-neutral-400">
      <p>Â© <span id="year"></span> TruthGuard. All rights reserved.</p>
      <div class="flex items-center gap-4">
        <a href="{{ url_for('main.about_page') }}#privacy" class="hover:text-neutral-900 dark:hover:text-neutral-200">Privacy</a>
        <a href="{{ url_for('main.about_page') }}#terms" class="hover:text-neutral-900 dark:hover:text-neutral-200">Terms</a>
        <a href="{{ url_for('main.about_page') }}#contact" class="hover:text-neutral-900 dark:hover:text-neutral-200">Contact</a>
      </div>
    </div>
  </footer>

  <script>
    // Footer year
    document.getElementById('year').textContent = new Date().getFullYear();

    // Keep body top padding equal to nav height
    function setNavHeight(){
      const bar = document.getElementById('navBar');
      const h = bar ? bar.offsetHeight : 64;
      document.documentElement.style.setProperty('--nav-h', h + 'px');
    }
    window.addEventListener('load', setNavHeight);
    window.addEventListener('resize', setNavHeight);
    if (document.fonts?.ready) {
      document.fonts.ready.then(setNavHeight);
    }

    // Theme button functionality
    document.addEventListener('DOMContentLoaded', () => {
      const current = localStorage.getItem('theme-preference') || 'dark';
      const label = document.getElementById('themeLabel');
      if (label) label.textContent = current[0].toUpperCase() + current.slice(1);
      
      document.querySelectorAll('[data-theme-option]').forEach(btn => {
        const active = btn.dataset.themeOption === current;
        if (active) {
          btn.classList.remove('bg-white','dark:bg-neutral-900/70','dark:bg-neutral-900/50');
        }
        btn.classList.toggle('bg-indigo-600', active && !document.documentElement.classList.contains('dark'));
        btn.classList.toggle('text-white', active && !document.documentElement.classList.contains('dark'));
        btn.classList.toggle('bg-indigo-500/25', active && document.documentElement.classList.contains('dark'));
        btn.classList.toggle('text-indigo-200', active && document.documentElement.classList.contains('dark'));
        btn.classList.toggle('theme-active', active);
        
        btn.addEventListener('click', () => {
          window.__setTheme(btn.dataset.themeOption);
          btn.closest('details')?.removeAttribute('open');
        });
      });

      // Set active state for user dropdown options
      function setActiveUserOption() {
        const path = window.location.pathname;
        const hash = window.location.hash;
        
        // Remove all active states first
        document.querySelectorAll('[data-user-option]').forEach(option => {
          option.classList.remove('user-active');
        });

        // Determine which option should be active
        let activeOption = null;
        if (path.includes('/auth/profile')) {
          activeOption = 'profile';
        } else if (hash === '#help' || path.includes('/about')) {
          activeOption = 'help';
        }

        // Apply active state
        if (activeOption) {
          const activeElement = document.querySelector(`[data-user-option="${activeOption}"]`);
          if (activeElement) {
            activeElement.classList.add('user-active');
          }
        }
      }

      // Call on page load and navigation changes
      setActiveUserOption();
      window.addEventListener('hashchange', setActiveUserOption);
      window.addEventListener('popstate', setActiveUserOption);
    });

    // Mobile menu functionality
    const btn = document.getElementById('menuBtn');
    const menu = document.getElementById('mobileMenu');
    const backdrop = document.getElementById('menuBackdrop');
    const header = document.getElementById('siteHeader');

    function setMenu(open){
      menu.classList.toggle('hidden', !open);
      backdrop.classList.toggle('hidden', !open);
      btn?.setAttribute('aria-expanded', String(open));
      document.body.classList.toggle('menu-open', open);
    }

    btn?.addEventListener('click', () => setMenu(menu.classList.contains('hidden')));
    backdrop?.addEventListener('click', () => setMenu(false));
    menu?.addEventListener('click', (e) => {
      const a = e.target.closest('a[href]');
      if (a) setMenu(false);
    });

    document.addEventListener('keydown', (e) => {
      if (e.key === 'Escape' && !menu.classList.contains('hidden')) setMenu(false);
    });

    window.addEventListener('hashchange', () => {
      if (!menu.classList.contains('hidden')) setMenu(false);
      setActiveNav();
    });

    document.addEventListener('click', (e) => {
      const isOpen = !menu.classList.contains('hidden');
      if (!isOpen) return;
      const clickedInsideHeader = header.contains(e.target);
      const clickedToggle = e.target.closest?.('#menuBtn');
      if (!clickedInsideHeader && !clickedToggle) {
        setMenu(false);
      }
    });

    window.addEventListener('resize', () => {
      const toDesktop = window.matchMedia('(min-width: 1280px)').matches;
      if (toDesktop && !menu.classList.contains('hidden')) setMenu(false);
    });

    // Theme dropdown hover functionality
    const themeDropdown = document.getElementById('themeDropdown');
    const themeSummary = document.getElementById('themeSummary');
    const themeMenu = document.getElementById('themeMenu');

    function sizeThemeMenu(){
      if (!themeSummary || !themeMenu) return;
      themeMenu.style.width = themeSummary.offsetWidth + 'px';
    }
    window.addEventListener('load', sizeThemeMenu);
    window.addEventListener('resize', sizeThemeMenu);

    let hoverCloseTimer = null;
    const openDrop = () => {
      closeAllDropdowns(); // Close other dropdowns first
      themeDropdown?.setAttribute('open','');
    };
    const closeDrop = () => themeDropdown?.removeAttribute('open');
    const cancelClose = () => { if (hoverCloseTimer) { clearTimeout(hoverCloseTimer); hoverCloseTimer = null; } };

    if (window.matchMedia('(hover: hover) and (pointer: fine)').matches) {
      themeDropdown?.addEventListener('mouseenter', () => { cancelClose(); openDrop(); });
      themeDropdown?.addEventListener('mouseleave', () => { cancelClose(); hoverCloseTimer = setTimeout(closeDrop, 180); });
    }

    // Click to toggle theme dropdown
    themeSummary?.addEventListener('click', (e) => {
      e.preventDefault();
      if (themeDropdown?.hasAttribute('open')) {
        closeDrop();
      } else {
        openDrop();
      }
    });

    // User dropdown hover functionality (similar to theme dropdown)
    const userDropdown = document.getElementById('userDropdown');
    const userSummary = document.getElementById('userSummary');
    const userMenu = document.getElementById('userMenu');

    function sizeUserMenu(){
      if (!userSummary || !userMenu) return;
      // Make user menu slightly wider than the summary
      userMenu.style.minWidth = (userSummary.offsetWidth + 20) + 'px';
    }
    window.addEventListener('load', sizeUserMenu);
    window.addEventListener('resize', sizeUserMenu);

    let userHoverCloseTimer = null;
    const openUserDrop = () => {
      closeAllDropdowns(); // Close other dropdowns first
      userDropdown?.setAttribute('open','');
    };
    const closeUserDrop = () => userDropdown?.removeAttribute('open');
    const cancelUserClose = () => { if (userHoverCloseTimer) { clearTimeout(userHoverCloseTimer); userHoverCloseTimer = null; } };

    if (window.matchMedia('(hover: hover) and (pointer: fine)').matches) {
      userDropdown?.addEventListener('mouseenter', () => { cancelUserClose(); openUserDrop(); });
      userDropdown?.addEventListener('mouseleave', () => { cancelUserClose(); userHoverCloseTimer = setTimeout(closeUserDrop, 180); });
    }

    // Click to toggle user dropdown
    userSummary?.addEventListener('click', (e) => {
      e.preventDefault();
      if (userDropdown?.hasAttribute('open')) {
        closeUserDrop();
      } else {
        openUserDrop();
      }
    });

    // Handle logout button click
    document.getElementById('logoutBtn')?.addEventListener('click', () => {
      document.getElementById('logoutForm')?.submit();
    });

    // More dropdown hover functionality (similar to theme/user dropdowns)
    const moreDropdown = document.getElementById('moreDropdown');
    const moreSummary = document.getElementById('moreSummary');
    const moreMenu = document.getElementById('moreMenu');

    function sizeMoreMenu(){
      if (!moreSummary || !moreMenu) return;
      // Keep the dropdown smaller than before
      moreMenu.style.minWidth = '8rem'; // w-32 equivalent (reduced from w-44)
    }
    window.addEventListener('load', sizeMoreMenu);
    window.addEventListener('resize', sizeMoreMenu);

    let moreHoverCloseTimer = null;
    const openMoreDrop = () => {
      closeAllDropdowns(); // Close other dropdowns first
      moreDropdown?.setAttribute('open','');
    };
    const closeMoreDrop = () => moreDropdown?.removeAttribute('open');
    const cancelMoreClose = () => { if (moreHoverCloseTimer) { clearTimeout(moreHoverCloseTimer); moreHoverCloseTimer = null; } };

    if (window.matchMedia('(hover: hover) and (pointer: fine)').matches) {
      moreDropdown?.addEventListener('mouseenter', () => { cancelMoreClose(); openMoreDrop(); });
      moreDropdown?.addEventListener('mouseleave', () => { cancelMoreClose(); moreHoverCloseTimer = setTimeout(closeMoreDrop, 180); });
    }

    // Click to toggle more dropdown
    moreSummary?.addEventListener('click', (e) => {
      e.preventDefault();
      if (moreDropdown?.hasAttribute('open')) {
        closeMoreDrop();
      } else {
        openMoreDrop();
      }
    });

    // Set active state for more dropdown options (both desktop and mobile)
    function setActiveMoreOption() {
      const hash = window.location.hash;
      
      // Remove all active states first (both desktop and mobile)
      document.querySelectorAll('[data-more-option]').forEach(option => {
        option.classList.remove('more-active');
      });
      document.querySelectorAll('[data-more-option-mobile]').forEach(option => {
        option.classList.remove('more-active');
      });

      // Determine which option should be active
      let activeOption = null;
      if (hash === '#about') {
        activeOption = 'about';
      } else if (hash === '#feedback') {
        activeOption = 'feedback';
      }

      // Apply active state to dropdown items (both desktop and mobile)
      if (activeOption) {
        const activeDesktopElement = document.querySelector(`[data-more-option="${activeOption}"]`);
        const activeMobileElement = document.querySelector(`[data-more-option-mobile="${activeOption}"]`);
        
        if (activeDesktopElement) {
          activeDesktopElement.classList.add('more-active');
        }
        if (activeMobileElement) {
          activeMobileElement.classList.add('more-active');
        }
      }

      // Note: Parent "More" button active state is now handled by setActiveNav()
    }

    // Call on page load and navigation changes
    setActiveMoreOption();
    window.addEventListener('hashchange', setActiveMoreOption);
    window.addEventListener('popstate', setActiveMoreOption);

    // Function to close all dropdowns
    function closeAllDropdowns() {
      closeDrop();
      closeUserDrop();
      closeMoreDrop();
    }

    // Close dropdowns when clicking outside
    document.addEventListener('click', (e) => {
      const dropdowns = [themeDropdown, userDropdown, moreDropdown].filter(Boolean);
      const clickedInside = dropdowns.some(dropdown => dropdown.contains(e.target));
      
      if (!clickedInside) {
        closeAllDropdowns();
      } else {
        // Close other dropdowns if clicking in one
        if (themeDropdown && !themeDropdown.contains(e.target)) {
          closeDrop();
        }
        if (userDropdown && !userDropdown.contains(e.target)) {
          closeUserDrop();
        }
        if (moreDropdown && !moreDropdown.contains(e.target)) {
          closeMoreDrop();
        }
      }
    });

    // Close dropdowns on escape key
    document.addEventListener('keydown', (e) => {
      if (e.key === 'Escape') {
        closeAllDropdowns();
      }
    });

    // Active nav state management
    function setActiveNav() {
      const path = window.location.pathname;
      const hash = window.location.hash;

      // Remove active states from all navigation elements
      document.querySelectorAll('.nav-link, .nav-link-mobile')
        .forEach(link => link.classList.remove('active'));
      
      // Remove active state from "More" dropdown summaries (both desktop and mobile)
      const moreSummary = document.getElementById('moreSummary');
      const moreSummaryMobile = document.getElementById('moreSummaryMobile');
      if (moreSummary) {
        moreSummary.classList.remove('more-parent-active');
      }
      if (moreSummaryMobile) {
        moreSummaryMobile.classList.remove('more-parent-active');
      }

      let key = 'home';
      let isMoreActive = false;

      // Check if hash corresponds to "More" dropdown items
      if (hash === '#about' || hash === '#feedback' || path.includes('/feedback') || path.includes('/about')) {
        isMoreActive = true;
        // Don't set a key for main nav, let "More" handle it
      } else if (path.includes('/detector') || path.includes('/results')) {
        key = 'detector';
      } else if (path.includes('/history')) {
        key = 'history';
      } else if (path.includes('/game')) {
        key = 'game';
      } else if (hash && hash !== '#about' && hash !== '#feedback') {
        key = hash.replace('#','') || 'home';
      }

      // Set active state for main navigation
      if (!isMoreActive) {
        document.querySelectorAll(`[data-nav="${key}"]`).forEach(el => el.classList.add('active'));
      }

      // Handle "More" dropdown active state (both desktop and mobile)
      if (isMoreActive) {
        if (moreSummary) {
          moreSummary.classList.add('more-parent-active');
        }
        if (moreSummaryMobile) {
          moreSummaryMobile.classList.add('more-parent-active');
        }
        
        // Set active state for specific dropdown item
        if (hash === '#feedback' || path.includes('/feedback')) {
          document.querySelectorAll('[data-more-option="feedback"]').forEach(el => el.classList.add('more-active'));
          document.querySelectorAll('[data-more-option-mobile="feedback"]').forEach(el => el.classList.add('more-active'));
        } else if (hash === '#about' || path.includes('/about')) {
          document.querySelectorAll('[data-more-option="about"]').forEach(el => el.classList.add('more-active'));
          document.querySelectorAll('[data-more-option-mobile="about"]').forEach(el => el.classList.add('more-active'));
        }
      }
    }

    document.addEventListener('DOMContentLoaded', setActiveNav);
    window.addEventListener('hashchange', setActiveNav);
    window.addEventListener('popstate', setActiveNav);
  </script>

  {% block body_extra %}{% endblock %}
</body>
</html>
